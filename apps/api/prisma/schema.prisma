// Prisma Schema for Paperless Examination System
// Multi-tenant, permission-centric architecture

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MULTI-TENANT ROOT
// ============================================

model University {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique
  address     String?
  city        String?
  state       String?
  country     String   @default("India")
  website     String?
  email       String?
  phone       String?
  logo        String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  // Relations
  schools     School[]
  users       User[]
  roles       Role[]
  exams       Exam[]
  auditLogs   AuditLog[]

  @@map("universities")
}

// ============================================
// ACADEMIC HIERARCHY
// ============================================

model School {
  id           String   @id @default(uuid())
  universityId String
  name         String
  code         String
  dean         String?
  email        String?
  phone        String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime?

  // Relations
  university   University   @relation(fields: [universityId], references: [id], onDelete: Cascade)
  departments  Department[]

  @@unique([universityId, code])
  @@index([universityId])
  @@map("schools")
}

model Department {
  id           String   @id @default(uuid())
  universityId String
  schoolId     String
  name         String
  code         String
  hod          String?
  email        String?
  phone        String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime?

  // Relations
  school       School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  programmes   Programme[]
  courses      Course[]

  @@unique([universityId, schoolId, code])
  @@index([universityId, schoolId])
  @@map("departments")
}

model Programme {
  id            String   @id @default(uuid())
  universityId  String
  departmentId  String
  name          String
  code          String
  duration      Int      // in semesters
  degree        String   // B.Tech, M.Tech, etc.
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?

  // Relations
  department    Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  courses       Course[]
  sections      Section[]

  @@unique([universityId, departmentId, code])
  @@index([universityId, departmentId])
  @@map("programmes")
}

model Course {
  id             String   @id @default(uuid())
  universityId   String
  departmentId   String
  programmeId    String?
  code           String
  name           String
  credits        Int
  semester       Int?
  isElective     Boolean  @default(false)
  syllabus       String?  // JSON or text
  courseOutcomes Json?    // CO definitions
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  deletedAt      DateTime?

  // Relations
  department     Department    @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  programme      Programme?    @relation(fields: [programmeId], references: [id], onDelete: SetNull)
  sections       Section[]
  questions      Question[]
  examCourses    ExamCourse[]

  @@unique([universityId, departmentId, code])
  @@index([universityId, departmentId])
  @@map("courses")
}

model Section {
  id               String   @id @default(uuid())
  universityId     String
  programmeId      String
  courseId         String
  name             String   // A, B, C
  semester         Int
  academicYear     String   // 2024-25
  maxStudents      Int      @default(60)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  programme        Programme       @relation(fields: [programmeId], references: [id], onDelete: Cascade)
  course           Course          @relation(fields: [courseId], references: [id], onDelete: Cascade)
  studentSections  StudentSection[]
  examSessions     ExamSession[]

  @@unique([universityId, programmeId, courseId, name, semester, academicYear])
  @@index([universityId, programmeId])
  @@map("sections")
}

// ============================================
// USER & ROLE MANAGEMENT (RBAC)
// ============================================

model User {
  id                String    @id @default(uuid())
  universityId      String
  email             String    @unique
  password          String
  firstName         String
  lastName          String
  phone             String?
  avatar            String?
  isActive          Boolean   @default(true)
  emailVerified     Boolean   @default(false)
  twoFactorEnabled  Boolean   @default(false)
  twoFactorSecret   String?
  lastLogin         DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?

  // Relations
  university        University        @relation(fields: [universityId], references: [id], onDelete: Cascade)
  userRoles         UserRole[]
  refreshTokens     RefreshToken[]
  studentSections   StudentSection[]
  questions         Question[]
  paperSetters      PaperSetter[]
  evaluations       Evaluation[]
  scrutinyRequests  ScrutinyRequest[]
  auditLogs         AuditLog[]

  @@index([universityId])
  @@index([email])
  @@map("users")
}

model Role {
  id           String   @id @default(uuid())
  universityId String
  name         String   // SUPER_ADMIN, DEAN, HOD, etc.
  description  String?
  isSystem     Boolean  @default(false) // System roles cannot be deleted
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  university      University       @relation(fields: [universityId], references: [id], onDelete: Cascade)
  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@unique([universityId, name])
  @@index([universityId])
  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique // CREATE_EXAM, APPROVE_PAPER, etc.
  description String?
  category    String?  // exam, user, academic, etc.
  createdAt   DateTime @default(now())

  // Relations
  rolePermissions RolePermission[]

  @@map("permissions")
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model RolePermission {
  id           String   @id @default(uuid())
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@map("role_permissions")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  isRevoked Boolean  @default(false)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ============================================
// EXAM MANAGEMENT
// ============================================

model Exam {
  id                String    @id @default(uuid())
  universityId      String
  name              String
  code              String
  academicYear      String
  semester          Int
  type              String    // MID_TERM, END_TERM, RETEST
  state             String    @default("DRAFT") // Enum: DRAFT, COURSE_LOCKED, GENERATED, etc.
  startDate         DateTime?
  endDate           DateTime?
  instructions      String?
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?

  // Relations
  university        University    @relation(fields: [universityId], references: [id], onDelete: Cascade)
  examCourses       ExamCourse[]
  papers            Paper[]
  examSessions      ExamSession[]
  stateTransitions  ExamStateTransition[]

  @@unique([universityId, code])
  @@index([universityId])
  @@index([state])
  @@map("exams")
}

model ExamCourse {
  id           String    @id @default(uuid())
  universityId String
  examId       String
  courseId     String
  maxMarks     Int
  duration     Int       // in minutes
  blueprint    Json?     // Question distribution by Bloom's, difficulty, CO
  isLocked     Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  exam         Exam      @relation(fields: [examId], references: [id], onDelete: Cascade)
  course       Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  papers       Paper[]

  @@unique([examId, courseId])
  @@index([universityId, examId])
  @@map("exam_courses")
}

// ============================================
// QUESTION BANK
// ============================================

model Question {
  id             String    @id @default(uuid())
  universityId   String
  courseId       String
  authorId       String
  type           String    // OBJECTIVE, SUBJECTIVE, etc.
  text           String    @db.Text
  options        Json?     // For MCQ: {a: "", b: "", c: "", d: ""}
  correctAnswer  String?   // For objective questions
  modelAnswer    String?   @db.Text
  explanation    String?   @db.Text
  marks          Int
  bloomLevel     String    // REMEMBER, UNDERSTAND, etc.
  difficulty     String    // EASY, MEDIUM, HARD
  courseOutcome  String?   // CO1, CO2, etc.
  keywords       String[]  // For search
  imageUrl       String?
  isModerated    Boolean   @default(false)
  moderatedBy    String?
  moderatedAt    DateTime?
  isSealed       Boolean   @default(false)
  isActive       Boolean   @default(true)
  version        Int       @default(1)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?

  // Relations
  course         Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  author         User             @relation(fields: [authorId], references: [id], onDelete: Restrict)
  paperQuestions PaperQuestion[]

  @@index([universityId, courseId])
  @@index([bloomLevel, difficulty])
  @@map("questions")
}

// ============================================
// PAPER GENERATION
// ============================================

model Paper {
  id              String    @id @default(uuid())
  universityId    String
  examId          String
  examCourseId    String
  setNumber       Int       // A, B, C represented as 1, 2, 3
  status          String    @default("DRAFT") // DRAFT, PENDING_APPROVAL, APPROVED, REJECTED
  encryptedData   String?   @db.Text // Encrypted paper before approval
  decryptionKey   String?
  generatedAt     DateTime?
  approvedBy      String?
  approvedAt      DateTime?
  rejectedReason  String?
  version         Int       @default(1)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  exam            Exam             @relation(fields: [examId], references: [id], onDelete: Cascade)
  examCourse      ExamCourse       @relation(fields: [examCourseId], references: [id], onDelete: Cascade)
  paperSections   PaperSection[]
  paperSetters    PaperSetter[]
  examSessions    ExamSession[]

  @@unique([examCourseId, setNumber])
  @@index([universityId, examId])
  @@map("papers")
}

model PaperSection {
  id           String   @id @default(uuid())
  paperId      String
  sectionName  String   // Section A, B, C
  instructions String?
  totalMarks   Int
  order        Int
  createdAt    DateTime @default(now())

  // Relations
  paper          Paper           @relation(fields: [paperId], references: [id], onDelete: Cascade)
  paperQuestions PaperQuestion[]

  @@index([paperId])
  @@map("paper_sections")
}

model PaperQuestion {
  id              String   @id @default(uuid())
  paperSectionId  String
  questionId      String
  questionNumber  Int
  marks           Int
  isOptional      Boolean  @default(false)
  order           Int
  createdAt       DateTime @default(now())

  // Relations
  paperSection PaperSection @relation(fields: [paperSectionId], references: [id], onDelete: Cascade)
  question     Question     @relation(fields: [questionId], references: [id], onDelete: Restrict)

  @@unique([paperSectionId, questionNumber])
  @@index([paperSectionId])
  @@map("paper_questions")
}

model PaperSetter {
  id        String   @id @default(uuid())
  paperId   String
  userId    String
  role      String   // SETTER, MODERATOR
  createdAt DateTime @default(now())

  // Relations
  paper Paper @relation(fields: [paperId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([paperId, userId, role])
  @@index([paperId])
  @@map("paper_setters")
}

// ============================================
// EXAM CONDUCTION
// ============================================

model ExamSession {
  id              String    @id @default(uuid())
  universityId    String
  examId          String
  paperId         String
  sectionId       String
  studentId       String
  startTime       DateTime?
  endTime         DateTime?
  submittedAt     DateTime?
  status          String    @default("NOT_STARTED") // NOT_STARTED, IN_PROGRESS, SUBMITTED
  ipAddress       String?
  userAgent       String?
  autoSaveVersion Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  exam            Exam            @relation(fields: [examId], references: [id], onDelete: Cascade)
  paper           Paper           @relation(fields: [paperId], references: [id], onDelete: Restrict)
  section         Section         @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  student         StudentSection  @relation(fields: [studentId, sectionId], references: [userId, sectionId])
  studentAnswers  StudentAnswer[]
  evaluations     Evaluation[]

  @@unique([examId, sectionId, studentId])
  @@index([universityId, examId])
  @@index([studentId])
  @@map("exam_sessions")
}

model StudentSection {
  id           String   @id @default(uuid())
  universityId String
  userId       String
  sectionId    String
  rollNumber   String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  section      Section       @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  examSessions ExamSession[]

  @@unique([userId, sectionId])
  @@index([universityId, sectionId])
  @@map("student_sections")
}

model StudentAnswer {
  id             String    @id @default(uuid())
  examSessionId  String
  questionId     String
  answerText     String?   @db.Text
  answerImage    String?   // Handwriting image URL
  selectedOption String?   // For MCQ
  version        Int       @default(1)
  savedAt        DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  examSession    ExamSession   @relation(fields: [examSessionId], references: [id], onDelete: Cascade)
  aiEvaluations  AIEvaluation[]

  @@unique([examSessionId, questionId])
  @@index([examSessionId])
  @@map("student_answers")
}

// ============================================
// EVALUATION SYSTEM
// ============================================

model Evaluation {
  id              String    @id @default(uuid())
  universityId    String
  examSessionId   String
  evaluatorId     String
  status          String    @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, APPROVED
  totalMarks      Int?
  marksObtained   Float?
  remarks         String?
  isApproved      Boolean   @default(false)
  approvedBy      String?
  approvedAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  examSession     ExamSession       @relation(fields: [examSessionId], references: [id], onDelete: Cascade)
  evaluator       User              @relation(fields: [evaluatorId], references: [id], onDelete: Restrict)
  questionMarks   QuestionMark[]
  aiEvaluations   AIEvaluation[]

  @@unique([examSessionId])
  @@index([universityId, examSessionId])
  @@index([evaluatorId])
  @@map("evaluations")
}

model QuestionMark {
  id            String   @id @default(uuid())
  evaluationId  String
  questionId    String
  marksAwarded  Float
  maxMarks      Int
  remarks       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  evaluation Evaluation @relation(fields: [evaluationId], references: [id], onDelete: Cascade)

  @@unique([evaluationId, questionId])
  @@index([evaluationId])
  @@map("question_marks")
}

model AIEvaluation {
  id              String    @id @default(uuid())
  evaluationId    String
  studentAnswerId String
  extractedText   String?   @db.Text
  detectedLang    String?
  translatedText  String?   @db.Text
  suggestedMarks  Float?
  confidence      Float?
  feedback        String?   @db.Text
  isAccepted      Boolean   @default(false)
  processedAt     DateTime  @default(now())

  // Relations
  evaluation    Evaluation    @relation(fields: [evaluationId], references: [id], onDelete: Cascade)
  studentAnswer StudentAnswer @relation(fields: [studentAnswerId], references: [id], onDelete: Cascade)

  @@index([evaluationId])
  @@index([studentAnswerId])
  @@map("ai_evaluations")
}

// ============================================
// RESULTS & SCRUTINY
// ============================================

model Result {
  id              String    @id @default(uuid())
  universityId    String
  examId          String
  studentId       String
  courseId        String
  totalMarks      Int
  marksObtained   Float
  percentage      Float
  grade           String?
  isPublished     Boolean   @default(false)
  publishedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  scrutinyRequests ScrutinyRequest[]

  @@unique([examId, studentId, courseId])
  @@index([universityId, examId])
  @@index([studentId])
  @@map("results")
}

model ScrutinyRequest {
  id             String    @id @default(uuid())
  universityId   String
  resultId       String
  requestedBy    String
  reason         String    @db.Text
  status         String    @default("REQUESTED") // REQUESTED, TEACHER_REVIEW, HOD_REVIEW, DEAN_REVIEW, APPROVED, REJECTED
  currentReviewer String?
  reviewComments Json?     // Array of {reviewerId, role, comment, decision, timestamp}
  finalDecision  String?
  oldMarks       Float
  newMarks       Float?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  resolvedAt     DateTime?

  // Relations
  result       Result @relation(fields: [resultId], references: [id], onDelete: Cascade)
  requester    User   @relation(fields: [requestedBy], references: [id], onDelete: Cascade)

  @@index([universityId, resultId])
  @@index([requestedBy])
  @@index([status])
  @@map("scrutiny_requests")
}

// ============================================
// EXAM STATE TRANSITIONS (Audit for State Machine)
// ============================================

model ExamStateTransition {
  id           String   @id @default(uuid())
  examId       String
  fromState    String
  toState      String
  transitionBy String   // User ID
  reason       String?
  ipAddress    String?
  createdAt    DateTime @default(now())

  // Relations
  exam Exam @relation(fields: [examId], references: [id], onDelete: Cascade)

  @@index([examId])
  @@map("exam_state_transitions")
}

// ============================================
// AUDIT TRAIL (Immutable)
// ============================================

model AuditLog {
  id           String   @id @default(uuid())
  universityId String
  userId       String?
  action       String   // CREATE, UPDATE, DELETE, STATE_CHANGE, etc.
  entityType   String   // User, Exam, Paper, etc.
  entityId     String
  beforeState  Json?
  afterState   Json?
  ipAddress    String?
  userAgent    String?
  timestamp    DateTime @default(now())

  // Relations
  university University @relation(fields: [universityId], references: [id], onDelete: Cascade)
  user       User?      @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([universityId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@map("audit_logs")
}
